# Gemini CLI Code Review

- model: gemini-2.5-flash-lite
- generated_at: 2026-02-15T13:32:57.614Z
- files_sent: 26
- total_bytes_sent: 203681

Este é um code review do projeto **Gemini CLI (WhatsApp-ML-Bot)**. O projeto apresenta uma arquitetura modular bem definida e um tratamento pragmático de integrações complexas (WhatsApp, OpenAI Vision e Mercado Livre).

### Resumo do Review
*   **Arquitetura Robusta:** O uso de `PQueue` para controle de concorrência e o padrão de `Services` isolados facilitam a manutenção e testes.
*   **Gestão de Sessão Eficaz:** O sistema de janelas para coleta de fotos e recuperação de sessões após reinícios demonstra maturidade.
*   **OAuth e Resiliência:** Excelente implementação de renovação de tokens com bloqueio de concorrência (`refreshInFlight`).
*   **Risco de Concorrência de Estado:** Há operações de "leitura-antes-da-escrita" fora dos locks atômicos no bot.
*   **Dependência de Erros da API:** O preenchimento de atributos obrigatórios é reativo, dependendo de parsing de strings de erro da API do ML.
*   **Segurança e Privacidade:** O uso de SHA256 para arquivos e limpeza periódica de mídia são boas práticas de privacidade.

---

### Problemas e Riscos por Severidade

#### CRÍTICO
1.  **Condição de Corrida na Criação de Sessão**
    *   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (método `handleImage`)
    *   **Problema:** O código verifica se existe uma sessão ativa com `this.store.read()` e, se não houver, decide criar uma. Como essa verificação ocorre fora do `this.store.update`, duas mensagens rápidas do mesmo usuário podem disparar dois fluxos paralelos que criam duas sessões diferentes antes que a primeira seja persistida.
    *   **Impacto:** Duplicação de anúncios e inconsistência na UX do grupo.

#### ALTO
1.  **Risco de Banimento (WhatsApp)**
    *   **Arquivo:** `src/bot/WhatsAppMlBot.ts`
    *   **Problema:** O uso de bibliotecas não-oficiais (Baileys) sempre carrega risco. Embora o `humanDelay` ajude, o download intensivo de mídia e a resposta automática imediata são padrões detectáveis.
    *   **Impacto:** Perda permanente do número do bot.

2.  **Fragilidade no Parsing de Erros de Atributos**
    *   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (método `extractAttributeIdsFromMlError`)
    *   **Problema:** O método usa Regex para extrair IDs de atributos (ex: `[BRAND]`) de mensagens de erro da API. APIs mudam formatos de erro sem aviso prévio. Se o ML mudar o formato, o bot deixará de instruir o usuário corretamente.
    *   **Impacto:** Impossibilidade de publicar anúncios em categorias com atributos obrigatórios novos.

3.  **Vazamento de Custos (OpenAI)**
    *   **Arquivo:** `src/bot/WhatsAppMlBot.ts` / `src/services/openaiVision.ts`
    *   **Problema:** Não há limite de sessões por usuário ou cooldown global. Um usuário mal-intencionado pode enviar fotos repetidamente, gerando custos significativos em chamadas Vision.
    *   **Impacto:** Prejuízo financeiro direto.

#### MÉDIO
1.  **Publicação Parcial (Estado Inconsistente)**
    *   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (método `publishSession`)
    *   **Problema:** A criação do item, o upload da descrição e o "pause" são chamadas sequenciais. Se o processo falhar após `createItem`, o anúncio pode ficar ATIVO e SEM DESCRIÇÃO no ML.
    *   **Impacto:** Anúncios de má qualidade ou vendas de itens não revisados.

2.  **Segurança de Tipos (Uso de `any`)**
    *   **Arquivo:** `src/bot/WhatsAppMlBot.ts`
    *   **Problema:** O uso extensivo de `any` para tipos do Baileys (`WAMessage`) oculta erros de propriedade que podem ocorrer em atualizações da biblioteca.

#### BAIXO
1.  **Hardcoded Prompts:** Os prompts da OpenAI e mensagens do bot estão espalhados pelo código, dificultando a internacionalização ou ajuste fino sem re-build.
2.  **SHA256 não explorado:** O hash das imagens é calculado mas não é usado para evitar o reprocessamento da mesma imagem (cache de análise).

---

### Melhorias Propostas

1.  **Operações Atômicas de Sessão:**
    *   Mover a lógica de "encontrar ou criar sessão" para dentro do callback do `store.update`. Isso garante que a criação de uma nova sessão seja uma operação transacional única.

2.  **Catálogo Proativo de Atributos:**
    *   **Onde:** `src/services/mercadoLivre.ts`
    *   **Por que:** Em vez de esperar o erro do `createItem`, chame `getCategoryAttributes` logo após a predição da categoria. Filtre os atributos com a tag `required` e já apresente as perguntas ao usuário no primeiro preview.

3.  **Controle de Orfandade de Itens (Dry Run Avançado):**
    *   Implementar um log de "IDs pendentes de pausa" para que, em caso de erro no meio da publicação, o bot possa tentar pausar o item criado em uma tarefa de background.

4.  **Uso de `zod` no ML Client:**
    *   Validar as respostas da API do Mercado Livre com `zod` (similar ao que foi feito no Vision) para evitar quebras por campos `undefined` inesperados.

---

### Testes Automatizados Essenciais

1.  **Unitário (ML Error Parsing):** Criar uma bateria de testes para `extractAttributeIdsFromMlError` simulando diversos JSONs de erro reais do Mercado Livre (incluindo erros de validação de atributos e erros de OAuth).
2.  **Integração (Draft Logic):** Testar `buildListingDraft` com diferentes `userInput` (sobrescrevendo título, forçando preço manual e enviando atributos customizados via `parseUserAttributeValue`).
3.  **Simulação de Concorrência:** Um teste que dispara 10 chamadas simultâneas de `handleImage` para o mesmo usuário e garante que apenas 1 sessão seja aberta.
4.  **Mock de Vision:** Testar o comportamento do bot quando a OpenAI retorna `confidence: 0.1` ou um JSON com `product: null`.

---

### Observações Específicas

*   **Baileys:** Recomenda-se adicionar um `interval` aleatório maior entre as mensagens de "digitando" (`sendPresenceUpdate`) para simular melhor um humano.
*   **OpenAI Vision:** O uso de `strict: true` em `json_schema` é excelente para garantir a corretude do JSON. Considere diminuir o `detail: 'high'` para `'low'` em fotos secundárias para economizar tokens sem perda significativa de contexto.
*   **Mercado Livre OAuth:** A implementação está correta. Certifique-se de que o `refresh_token` antigo seja descartado imediatamente após a troca, conforme as novas políticas de segurança do ML.
