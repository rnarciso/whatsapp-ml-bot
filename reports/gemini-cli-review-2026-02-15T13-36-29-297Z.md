# Gemini CLI Code Review

- model: gemini-2.5-flash-lite
- generated_at: 2026-02-15T13:36:29.298Z
- files_sent: 26
- total_bytes_sent: 206256

Aqui está uma revisão de código técnica e pragmática do projeto **whatsapp-ml-bot**.

### Resumo Executivo
*   **Arquitetura Sólida:** O uso de serviços desacoplados e uma "store" com escrita atômica demonstra maturidade no design.
*   **Robustez na API do ML:** Excelente sacada ao implementar o fallback de OAuth para contornar o *PolicyAgent* (403) do Mercado Livre.
*   **Integração OpenAI:** Uso correto de *Structured Outputs* com fallback, garantindo tipagem no processamento de visão.
*   **Risco de Banimento:** O uso de Baileys (não-oficial) em grupos é o ponto de maior vulnerabilidade operacional.
*   **Escalabilidade:** O banco de dados em JSON (`db.json`) e a carga total em memória podem se tornar um gargalo conforme o volume de sessões cresce.
*   **UX de Grupo:** A lógica de coleta de fotos com janela de tempo (`PHOTO_COLLECT_WINDOW_SEC`) é muito bem pensada para o ambiente de chat.

---

### Riscos e Problemas por Severidade

#### [CRÍTICO] Risco de Suspensão de Conta (WhatsApp)
*   **Arquivo:** `src/bot/WhatsAppMlBot.ts`
*   **Descrição:** Bots em grupos usando bibliotecas não-oficiais (Baileys) são alvos fáceis para os algoritmos de detecção do WhatsApp. Embora existam `humanDelay` e `sendQueue`, o comportamento de responder a todas as imagens pode ser interpretado como spam.
*   **Impacto:** Perda definitiva do número de telefone associado ao bot.

#### [ALTO] Vazamento de Memória e Performance do DB
*   **Arquivo:** `src/storage/store.ts`
*   **Descrição:** A classe `JsonDbStore` lê o arquivo inteiro, faz o parse e mantém em cache. Em `update`, ela clona o objeto via `JSON.stringify/parse`. Com milhares de sessões, o consumo de memória e o tempo de bloqueio do Event Loop durante a clonagem serão proibitivos.
*   **Impacto:** Lentidão generalizada e crash por *Out of Memory* (OOM).

#### [ALTO] Persistência de Mídia e PII (Privacidade)
*   **Arquivo:** `src/services/cleanup.ts` e `src/bot/WhatsAppMlBot.ts`
*   **Descrição:** Fotos de usuários (que podem conter rostos, endereços ou documentos ao fundo) são salvas em disco sem criptografia. O processo de limpeza (`cleanup`) é baseado em tempo, mas se o bot cair, arquivos órfãos podem persistir.
*   **Impacto:** Exposição de dados sensíveis e conformidade com LGPD comprometida.

#### [MÉDIO] Falha Silenciosa em Fluxos Assíncronos
*   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (Método `onMessage`)
*   **Descrição:** O método `onMessage` chama `this.queue.add(() => this.onMessage(msg))`, mas não há um `.catch()` ou tratamento de erro global na promessa retornada pela fila para alertas administrativos.
*   **Impacto:** O bot pode parar de responder a um usuário específico sem deixar rastros claros além dos logs.

#### [MÉDIO] Dependência de Atributos do Mercado Livre
*   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (Método `publishSession`)
*   **Descrição:** A publicação pode falhar após a criação do item (ao tentar definir a descrição ou pausar). Embora o código tente mitigar isso, um erro na API de descrição deixa o anúncio "vazio" no ML.
*   **Impacto:** Experiência ruim para o usuário que precisará editar manualmente campos básicos.

---

### Propostas de Melhoria

#### 1. Implementar um "Circuit Breaker" para OpenAI
*   **Por que:** Erros de quota ou latência na OpenAI podem travar a `queue` de processamento.
*   **Como:** Adicionar um timeout explícito e um contador de erros consecutivos no `OpenAIVisionService`.

#### 2. Melhorar a Extração de Atributos Obrigatórios
*   **Arquivo:** `src/bot/WhatsAppMlBot.ts` / `formatPublishError`
*   **Melhoria:** O bot já tenta extrair IDs de atributos de erros do ML. Seria ideal que ele também sugerisse os valores padrão (como `N/A` ou `Não se aplica`) para atributos que o Vision não identificou, mas que o ML exige (ex: `GTIN`).

#### 3. Migrar para SQLite (ou similar)
*   **Arquivo:** `src/storage/store.ts`
*   **Melhoria:** Substituir o `JsonDbStore` por um banco de dados relacional leve (SQLite via `better-sqlite3`).
*   **Benefício:** Consultas parciais (não carregar tudo em memória), transações reais e maior robustez contra corrupção de arquivos em quedas de energia.

#### 4. Validação de Tamanho de Imagem no Buffer
*   **Arquivo:** `src/bot/WhatsAppMlBot.ts`
*   **Melhoria:** Validar o tamanho da imagem *antes* de gravar no disco, usando os metadados da mensagem do Baileys, para evitar ataques de esgotamento de disco (DoS).

---

### Observações Específicas

*   **Baileys:** O uso de `useMultiFileAuthState` é a escolha correta para persistência de sessão. Recomenda-se desativar o recebimento de chamadas e o status "visto" para reduzir o tráfego detectável pelo WhatsApp.
*   **ML OAuth:** A implementação do `refresh_token` automático no `getAccessToken` está excelente e segue as melhores práticas de segurança de tokens.
*   **ML Attributes:** O suporte a `@id` (value_id) via texto é uma funcionalidade "power user" essencial para evitar erros de validação em categorias complexas (Autopeças, Moda).
*   **Status Paused:** O bot cria o item como `paused` e depois tenta pausar novamente por segurança. Isso é prudente dado que o ML às vezes ignora o status inicial dependendo da reputação da conta.

---

### Sugestão de Testes Essenciais

1.  **Testes de Integração (Mocks):** Simular um erro `403 PolicyAgent` na busca de similares e garantir que o cliente ML dispare o refresh de token e tente novamente.
2.  **Teste de Concorrência:** Simular dois usuários enviando fotos simultaneamente no mesmo grupo para garantir que as sessões não se misturem (isolamento por `senderId`).
3.  **Teste de Cleanup:** Validar que arquivos órfãos (arquivos em `media/` que não constam no `db.json`) são removidos corretamente pelo `runCleanupOnce`.
4.  **Teste de Parsing:** Validar o `parseKeyValueLines` com entradas malformadas (ex: chaves sem valor, múltiplas igualdades, emojis no meio).

### Avaliação Final
O projeto está **muito bem escrito** para um MVP/Ferramenta interna. A lógica de negócio está bem protegida por validações do Zod e o fluxo de interação no WhatsApp é intuitivo. O foco principal agora deve ser a **segurança de dados** e a **estratégia anti-banimento** do WhatsApp.
