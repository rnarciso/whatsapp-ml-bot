# Gemini CLI Code Review

- model: gemini-2.5-flash-lite
- generated_at: 2026-02-15T00:53:17.307Z
- files_sent: 26
- total_bytes_sent: 191673

Aqui est√° o Code Review do projeto `whatsapp-ml-bot`.

### Resumo Executivo

O projeto √© um MVP funcional e bem estruturado para o escopo proposto. O uso de TypeScript com defini√ß√µes de tipos estritas (`strict: true`) e a separa√ß√£o de responsabilidades (Services, Bot, Storage) s√£o pontos fortes. A integra√ß√£o com APIs externas (OpenAI, Mercado Livre) demonstra bom entendimento dos fluxos.

No entanto, a arquitetura atual baseada em arquivo JSON √∫nico para banco de dados e a gest√£o de estado ass√≠ncrona apresentam **condi√ß√µes de corrida (race conditions)** que causar√£o bugs de estado (ex: reviver sess√µes canceladas) em produ√ß√£o. Al√©m disso, a depend√™ncia do Baileys exige monitoramento constante devido √† natureza n√£o oficial da API.

---

### Classifica√ß√£o de Riscos e Problemas

#### üî¥ CR√çTICO (Prioridade Imediata)

1.  **Condi√ß√£o de Corrida (Race Condition) no Estado da Sess√£o:**
    *   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (m√©todo `analyzeSession`)
    *   **Problema:** O m√©todo l√™ o estado, executa uma opera√ß√£o longa (OpenAI Vision ~5-10s) e depois atualiza o banco. Se o usu√°rio digitar "cancelar" durante a an√°lise, o comando `cancelActiveSession` roda, define o status como `cancelled`. Quando a OpenAI responde, o `analyzeSession` executa `this.store.update` e **sobrescreve** o status de volta para `awaiting_user_info`, "revivendo" uma sess√£o cancelada.
    *   **Corre√ß√£o:** Dentro do callback do `store.update`, verifique se o status atual ainda √© compat√≠vel com a transi√ß√£o desejada antes de aplicar as mudan√ßas.

2.  **Persist√™ncia N√£o Escal√°vel (JSON Store):**
    *   **Arquivo:** `src/storage/store.ts`
    *   **Problema:** O `JsonDbStore` l√™ e escreve o arquivo inteiro (`db.json`) a cada opera√ß√£o. Conforme o hist√≥rico cresce, a performance degradar√° linearmente, bloqueando o Event Loop durante o `JSON.parse/stringify`.
    *   **Corre√ß√£o:** Migrar para **SQLite** (via `better-sqlite3` ou `prisma`) ou uma store Key-Value em disco apropriada (ex: `leveldb`).

#### üü† ALTO (Aten√ß√£o Necess√°ria)

3.  **Seguran√ßa de Tokens:**
    *   **Arquivo:** `src/storage/store.ts` / `db.json`
    *   **Problema:** Os tokens de acesso e refresh do Mercado Livre est√£o sendo salvos em texto plano dentro de `db.json`. Se esse arquivo vazar (backup, commit acidental, exfiltra√ß√£o), a conta do vendedor fica comprometida.
    *   **Corre√ß√£o:** Criptografar os tokens em repouso (at rest) usando uma chave definida no `.env`, ou usar um gerenciador de segredos.

4.  **Risco de Banimento (WhatsApp/Baileys):**
    *   **Contexto:** Geral.
    *   **Problema:** O Baileys emula um navegador. Comportamentos de bot (respostas instant√¢neas, rajadas de mensagens) aumentam o risco de desconex√£o ou banimento do n√∫mero.
    *   **Corre√ß√£o:** Implementar "atrasos humanos" aleat√≥rios (simula√ß√£o de digita√ß√£o) antes de enviar respostas, especialmente as longas.

#### üü° M√âDIO (Melhorias de Qualidade)

5.  **Valida√ß√£o de Atributos do ML Fr√°gil:**
    *   **Arquivo:** `src/bot/WhatsAppMlBot.ts`
    *   **Problema:** A l√≥gica de valida√ß√£o de atributos obrigat√≥rios depende de o usu√°rio digitar exatamente a chave ou usar aliases limitados. O Mercado Livre √© muito estrito com `value_id` para atributos como Marca e Modelo em certas categorias.
    *   **Corre√ß√£o:** Melhorar o fluxo de perguntas. Se o ML rejeitar por atributo inv√°lido, o bot deveria listar as op√ß√µes v√°lidas (ex: bot√µes ou lista numerada) em vez de apenas texto livre.

6.  **Gerenciamento de Mem√≥ria (Buffer de Imagens):**
    *   **Arquivo:** `src/bot/WhatsAppMlBot.ts`
    *   **Problema:** `downloadMediaMessage` carrega a imagem inteira em mem√≥ria (Buffer). Se muitos usu√°rios enviarem fotos de alta resolu√ß√£o simultaneamente, o consumo de RAM explodir√°.
    *   **Corre√ß√£o:** Usar Streams para salvar o arquivo diretamente no disco, evitando carregar o buffer completo na mem√≥ria da aplica√ß√£o antes de salvar.

---

### Code Review Detalhado & Refatora√ß√µes

#### 1. Corre√ß√£o da Race Condition (`src/bot/WhatsAppMlBot.ts`)

O padr√£o "Check-then-Act" com opera√ß√µes ass√≠ncronas no meio √© o problema. A corre√ß√£o deve ocorrer no momento da escrita.

```typescript
// Sugest√£o de altera√ß√£o em analyzeSession
await this.store.update((db2) => {
  const s = db2.sessions[sessionId];
  // VERIFICA√á√ÉO DE SEGURAN√áA:
  // S√≥ aplica o resultado da an√°lise se a sess√£o ainda estiver no estado esperado.
  // Se o usu√°rio cancelou, o status seria 'cancelled'.
  if (!s || s.status !== 'analyzing') {
    logger.info({ sessionId, currentStatus: s?.status }, 'Sess√£o mudou de estado durante an√°lise. Ignorando resultado.');
    return;
  }

  s.vision = vision;
  // ... resto da l√≥gica
  s.status = 'awaiting_user_info';
  s.updatedAt = nowMs();
});
```

#### 2. Robustez no Parser de Input (`src/utils/kv.ts`)

O parser atual √© simples mas falha se o usu√°rio usar delimitadores diferentes ou quebras de linha confusas.

*   **Sugest√£o:** Usar uma biblioteca de parsing de linguagem natural simples ou refinar a Regex para aceitar `chave: valor` (com dois pontos) al√©m de `chave=valor`, pois no celular √© comum o corretor colocar espa√ßo ap√≥s o igual ou usar dois pontos.

#### 3. Otimiza√ß√£o do OpenAI Vision (`src/services/openaiVision.ts`)

Voc√™ est√° enviando as imagens como Base64 Data URLs.
*   **Problema:** Aumenta o tamanho do payload em ~33% e consome tokens/banda desnecessariamente se as imagens forem grandes (4K).
*   **Melhoria:** Redimensionar as imagens (usando `sharp`) para no m√°ximo 1024x1024 antes de enviar para a OpenAI. Isso economiza tokens e acelera a resposta sem perda significativa de precis√£o para reconhecimento de produtos.

#### 4. Tratamento de Erros na Fila (`src/bot/WhatsAppMlBot.ts`)

```typescript
// Atual:
void this.queue.add(() => this.onMessage(msg));

// Problema: Se onMessage lan√ßar um erro n√£o tratado, a Promise rejeitada fica solta.
// Melhoria:
this.queue.add(() => this.onMessage(msg).catch(err => {
    logger.error({ err, msgId: msg.key.id }, 'Erro fatal processando mensagem');
}));
```

---

### Observa√ß√µes Espec√≠ficas Solicitadas

*   **WhatsApp via Baileys:**
    *   A implementa√ß√£o do `useMultiFileAuthState` est√° correta.
    *   A detec√ß√£o de `DisconnectReason.loggedOut` para evitar loop de reconex√£o √© boa pr√°tica.
    *   *Dica:* Adicione uma verifica√ß√£o peri√≥dica de sanidade (ping) no socket, pois √†s vezes o Baileys perde a conex√£o sem emitir o evento de `close` imediatamente.

*   **OpenAI Vision:**
    *   O uso de `json_schema` (Structured Outputs) √© excelente para garantir a tipagem do retorno. O fallback para `json_object` est√° bem implementado.
    *   O prompt est√° bom, mas poderia ser mais enf√°tico em pedir para **n√£o alucinar** atributos t√©cnicos que n√£o s√£o vis√≠veis (ex: capacidade de GB, voltagem) a menos que estejam escritos na etiqueta.

*   **Mercado Livre API:**
    *   A l√≥gica de `isPolicyAgentForbidden` √© crucial e est√° bem feita. O ML frequentemente bloqueia chamadas p√∫blicas baseadas em IP/User-Agent, exigindo OAuth.
    *   *Status Paused:* Criar como pausado √© a estrat√©gia correta. Por√©m, certifique-se de que o `listing_type_id` configurado (default `gold_special`) permite an√∫ncios pausados sem cobran√ßa imediata (geralmente sim, mas em contas novas pode haver restri√ß√µes).

---

### Plano de Testes Automatizados

O projeto j√° usa `vitest`, mas faltam testes de integra√ß√£o cr√≠ticos.

1.  **Teste de Fluxo de Estado (State Machine):**
    *   Simular uma sess√£o: `collecting` -> `analyzing` -> `awaiting_user_info`.
    *   Testar a "Race Condition" descrita acima: disparar `cancel` enquanto o `analyze` est√° "pendente" (mockado com delay) e garantir que o estado final seja `cancelled`.

2.  **Mock do Baileys:**
    *   Criar um mock do socket para testar se o bot responde √†s mensagens corretas e ignora mensagens antigas ou de outros grupos.

3.  **Parsers:**
    *   Testar `listingDraft.ts` com inputs "sujos" (ex: "pre√ßo 100", "condi√ß√£o nova", "obs: produto riscado").

### Pr√≥ximos Passos (Action Items)

1.  **Corrigir a Race Condition** no `WhatsAppMlBot.ts`.
2.  **Sanitizar inputs:** Adicionar redimensionamento de imagem com `sharp` antes de enviar para OpenAI e ML.
3.  **Seguran√ßa:** Criptografar tokens no DB ou mover para armazenamento seguro.
4.  **Refatora√ß√£o de DB:** Se o projeto for al√©m de uso pessoal, substituir `JsonDbStore` por SQLite.

O c√≥digo est√° limpo e leg√≠vel, o que facilita muito a aplica√ß√£o dessas corre√ß√µes. Bom trabalho!
