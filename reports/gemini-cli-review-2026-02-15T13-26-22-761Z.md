# Gemini CLI Code Review

- model: gemini-2.5-flash-lite
- generated_at: 2026-02-15T13:26:22.762Z
- files_sent: 26
- total_bytes_sent: 198906

Este é um code review do projeto **WhatsApp -> Mercado Livre Bot**. No geral, o projeto está muito bem estruturado, com uma separação clara de responsabilidades, uso de TypeScript moderno (NodeNext) e boas práticas de configuração (Zod, Dotenv).

### Resumo Executivo

*   **Arquitetura Sólida:** Separação clara entre a camada de transporte (WhatsApp/Baileys), lógica de negócio (Services) e persistência (Store).
*   **Gestão de Estado Crítica:** O uso de `db.json` e timers em memória (`analysisTimers`) torna o bot vulnerável a reinicializações, podendo deixar sessões "presas".
*   **Complexidade do Mercado Livre:** A lógica de atributos obrigatórios é o ponto mais frágil da integração, dependendo de parsing de strings de erro que podem mudar.
*   **Segurança de Dados:** Tokens OAuth e mídias são armazenados localmente; a limpeza automática (Cleanup) é essencial e está implementada, mas carece de redundância.
*   **UX Pragmática:** O fluxo de "anúncio pausado" é uma excelente decisão de design para mitigar erros de IA e evitar publicações indesejadas.

---

### Code Review Detalhado

#### 1. Severidade: ALTA (Robustez e Persistência)

*   **Problema: Timers em Memória vs. Reinicializações**
    *   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (linhas 96, 281-285)
    *   **Descrição:** O bot utiliza `setTimeout` (`analysisTimers`) para aguardar a janela de envio de fotos. Se o processo cair ou for reiniciado, esses timers morrem. A sessão no `db.json` ficará com status `collecting_photos` indefinidamente ou até o cleanup de inatividade (72h).
    *   **Impacto:** Usuário envia fotos e o bot nunca responde após um reboot.
    *   **Melhoria:** No método `start()`, verificar se existem sessões no banco com status `collecting_photos` e agendar a análise imediatamente ou baseada no `collectUntil` persistido.

*   **Problema: Concorrência no `JsonDbStore`**
    *   **Arquivo:** `src/storage/store.ts`
    *   **Descrição:** Embora use `p-queue` para serializar escritas, o `JsonDbStore` lê e escreve o arquivo inteiro a cada mudança. Em grupos de WhatsApp muito ativos com múltiplos usuários iniciando sessões, o I/O de disco pode se tornar um gargalo ou causar corrupção se o `rename` falhar.
    *   **Impacto:** Perda de dados da base de sessões.
    *   **Melhoria:** Para um bot de escala média, considerar SQLite (via `better-sqlite3`) para persistência de sessões e tokens.

#### 2. Severidade: MÉDIA (Integração ML e IA)

*   **Problema: Parsing Frágil de Erros de Atributos**
    *   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (método `extractAttributeIdsFromMlError`)
    *   **Descrição:** A extração de IDs de atributos como `[BRAND]` via Regex a partir da mensagem de erro da API do Mercado Livre é perigosa. APIs podem mudar o formato das mensagens de erro ou localizar para outros idiomas.
    *   **Impacto:** O bot falha em avisar ao usuário quais campos faltam para publicar.
    *   **Melhoria:** Priorizar os campos `cause` ou `error_values` estruturados que a API do ML retorna no JSON de erro (400 Bad Request), em vez de fazer parse da string `message`.

*   **Problema: Falta de Retry Estratégico na OpenAI**
    *   **Arquivo:** `src/services/openaiVision.ts`
    *   **Descrição:** Chamadas de visão são caras e demoradas. Não há uma política de retry para erros de rede ou rate limit da OpenAI (429).
    *   **Impacto:** Falha na análise de fotos exige que o usuário envie tudo de novo.
    *   **Melhoria:** Implementar um retry exponencial simples nas chamadas do `OpenAI` e `MercadoLivreClient`.

#### 3. Severidade: BAIXA (UX e Manutenibilidade)

*   **Problema: Formato Rígido de Resposta (KV)**
    *   **Arquivo:** `src/utils/kv.ts`
    *   **Descrição:** O bot espera `chave=valor`. Usuários de WhatsApp tendem a responder de forma natural (ex: "é usado").
    *   **Melhoria:** Adicionar um pequeno processamento de linguagem natural ou regex para capturar valores comuns como "novo" ou "usado" mesmo sem o prefixo `condicao=`.

*   **Problema: Download de Mídia sem Limite de Tamanho**
    *   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (linha 246)
    *   **Descrição:** O bot baixa qualquer imagem enviada. Embora o ML e a OpenAI tenham limites, um usuário mal-intencionado pode enviar imagens gigantescas para esgotar o disco.
    *   **Melhoria:** Verificar o `fileLength` no `imageMessage` antes de iniciar o download.

---

### Observações Específicas

#### WhatsApp (Baileys)
*   **Risco de Banimento:** O uso de Baileys é não-oficial. O bot implementa `humanDelay`, o que é excelente. Recomendo aumentar o delay entre mensagens e evitar disparos em massa em grupos muito grandes.
*   **Mensagens Antigas:** O bot não parece ignorar mensagens que chegaram enquanto ele estava offline (dependendo da configuração do Baileys). Isso pode causar uma "enxurrada" de respostas ao ligar o bot após muito tempo.

#### OpenAI Vision
*   **Custos:** O uso de `gpt-4o-mini` é uma escolha inteligente para custo-benefício. Certifique-se de que o parâmetro `detail: 'high'` é realmente necessário, pois consome muito mais tokens que o `low`.

#### Mercado Livre API
*   **OAuth:** A lógica de refresh token no `getAccessToken` está correta e robusta, incluindo a margem de segurança de 60s.
*   **Status Paused:** Manter o item como `paused` e publicar a descrição em um segundo passo (`setDescription`) é a forma correta e mais segura de evitar que o usuário perca dinheiro com anúncios mal configurados pela IA.

---

### Testes Automatizados Essenciais (Sugestões)

1.  **Unitários (Prioridade Máxima):**
    *   `src/utils/kv.ts`: Testar variações de espaços, quebras de linha e caracteres especiais no parse de chave-valor.
    *   `src/services/pricing.ts`: Testar com arrays vazios, preços absurdos (outliers) e moedas diferentes.
2.  **Integração (Mocks):**
    *   `ML_Error_Parsing`: Criar um teste que simula o JSON de erro do Mercado Livre para garantir que os atributos faltantes são extraídos corretamente.
3.  **Fluxo de Sessão:**
    *   Testar a transição de estado da sessão (`collecting` -> `analyzing` -> `done`) garantindo que nenhuma transição inválida ocorra.

### Proposta de Melhoria Implementável

No arquivo `src/services/mercadoLivre.ts`, a função `searchSimilar` poderia ser melhorada para filtrar resultados que não possuem foto ou que têm preços discrepantes demais (ex: acessórios do produto em vez do produto em si), melhorando a precisão do `pricing.ts`.
