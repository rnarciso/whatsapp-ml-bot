# Gemini CLI Code Review

- model: gemini-2.5-flash-lite
- generated_at: 2026-02-15T13:29:47.698Z
- files_sent: 26
- total_bytes_sent: 201810

# Code Review: WhatsApp -> Mercado Livre Bot

Este code review foca em robustez, seguran√ßa e integra√ß√£o com as APIs de WhatsApp (n√£o-oficial), OpenAI Vision e Mercado Livre. O projeto est√° bem estruturado, utiliza tipos TypeScript de forma eficaz e possui uma gest√£o de estado (sess√µes) s√≥lida para um ambiente de CLI/Bot.

## Resumo Executivo (Bullets)

*   **Arquitetura de Sess√£o:** Excelente uso de um "photo collection window" para agrupar m√∫ltiplas imagens antes de processar.
*   **Persist√™ncia:** O uso de `p-queue` para garantir escritas at√¥micas no `db.json` √© uma solu√ß√£o pragm√°tica e segura para volumes baixos/m√©dios.
*   **Integra√ß√£o ML:** Tratamento sofisticado do erro `PolicyAgent` (403) e l√≥gica de extra√ß√£o de atributos de erros da API.
*   **IA Generativa:** Uso correto de *Structured Outputs* com Zod para garantir que a vis√£o da IA retorne JSON v√°lido.
*   **Risco de Concorr√™ncia:** Vulnerabilidade cr√≠tica na renova√ß√£o de tokens OAuth do Mercado Livre (race conditions).
*   **Seguran√ßa de M√≠dia:** Risco de vazamento de arquivos tempor√°rios se o processo for interrompido bruscamente (embora haja um loop de cleanup).
*   **UX de Atributos:** A depend√™ncia de IDs t√©cnicos (ex: `BRAND`) pode ser dif√≠cil para o usu√°rio final; falta um mapeamento de nomes amig√°veis.

---

## Detalhamento por Severidade

### üî¥ CR√çTICO

**1. Race Condition na Renova√ß√£o do Token OAuth**
*   **Arquivo:** `src/services/mercadoLivre.ts` (m√©todo `getAccessToken`)
*   **Problema:** O Mercado Livre utiliza *refresh tokens* rotativos (um s√≥ uso). Se duas sess√µes de an√°lise expirarem ao mesmo tempo, ambas chamar√£o `getAccessToken`. Como n√£o h√° um lock/mutex, ambas podem tentar usar o mesmo *refresh token* simultaneamente. Uma falhar√° e invalidar√° o acesso do bot por completo at√© uma interven√ß√£o manual (`npm run ml:oauth`).
*   **Recomenda√ß√£o:** Utilize um mutex (ex: `async-mutex`) no m√©todo `getAccessToken` para garantir que apenas uma renova√ß√£o ocorra por vez e que chamadas subsequentes usem o novo token j√° em cache.

### üü° ALTO

**2. Manipula√ß√£o de Erros no Baileys (Media Download)**
*   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (m√©todo `handleImage`)
*   **Problema:** Se o download da imagem falhar por timeout ou link expirado (comum se o bot cair e voltar depois), o c√≥digo apenas loga o erro e a sess√£o fica sem a imagem, mas o bot n√£o avisa o usu√°rio de forma clara sobre a perda daquele arquivo espec√≠fico.
*   **Recomenda√ß√£o:** Adicionar um `try/catch` no download e enviar uma mensagem de erro imediata solicitando o reenvio da foto caso o buffer venha vazio ou a stream falhe.

**3. Crescimento de Dados do `db.json`**
*   **Arquivo:** `src/storage/store.ts`
*   **Problema:** O `JsonDbStore` carrega e salva o arquivo inteiro em cada opera√ß√£o. Com o tempo, mesmo com o cleanup, o custo de `JSON.stringify` e `JSON.parse` bloquear√° o event loop.
*   **Recomenda√ß√£o:** Considere utilizar um banco de dados KV real (como SQLite ou LevelDB) se o n√∫mero de sess√µes hist√≥rico crescer muito, ou garanta que o cleanup de 30 dias seja rigoroso.

### üü¢ M√âDIO

**4. Redund√¢ncia na Cria√ß√£o de Item Pausado**
*   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (m√©todo `publishSession`)
*   **Problema:** O payload gerado por `mlPayload.ts` j√° envia `status: 'paused'`. Chamar `this.ml.pauseItem(created.id)` logo em seguida √© redundante e consome um request extra de API.
*   **Recomenda√ß√£o:** Remover a chamada de `pauseItem` se o `createItem` j√° for bem-sucedido com o status correto.

**5. Mapeamento de Atributos Obrigat√≥rios**
*   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (m√©todo `formatPublishError`)
*   **Problema:** O bot extrai IDs como `[BRAND]` do erro. Para um usu√°rio comum, digitar `MARCA=Samsung` √© intuitivo, mas `BRAND=Samsung` nem sempre.
*   **Recomenda√ß√£o:** Usar o resultado de `getCategoryAttributes` para mapear o `name` (ex: "Marca") para o `id` (ex: `BRAND`), permitindo que o usu√°rio responda em linguagem natural.

### üîµ BAIXO

**6. Limpeza de M√≠dias √ìrf√£s**
*   **Arquivo:** `src/services/cleanup.ts`
*   **Problema:** O cleanup deleta arquivos baseados no que est√° no `db.json`. Se um arquivo for criado mas o bot crashar antes de registrar no JSON, ele se torna um arquivo "leak" no disco.
*   **Recomenda√ß√£o:** No in√≠cio do cleanup, listar o diret√≥rio `data/media` e deletar qualquer arquivo que n√£o esteja referenciado em nenhuma sess√£o ativa/terminal.

---

## Proposta de Melhorias Implement√°veis

1.  **Mutex no OAuth:**
    ```ts
    // No MercadoLivreClient
    private refreshMutex = new Mutex();
    async getAccessToken() {
      const release = await this.refreshMutex.acquire();
      try { /* ... l√≥gica de refresh ... */ } finally { release(); }
    }
    ```
2.  **Deduplica√ß√£o de Imagens:** Calcular o `sha256` antes de salvar permanentemente para evitar processar a mesma imagem enviada por engano (j√° existe o c√°lculo, falta o check de exist√™ncia).
3.  **Melhoria na Descri√ß√£o:** Adicionar automaticamente as perguntas respondidas pelo usu√°rio (ex: "Acompanha carregador: Sim") ao final da descri√ß√£o do an√∫ncio para aumentar a transpar√™ncia.

---

## Sugest√£o de Testes Essenciais

1.  **Unit√°rio (Atributos):** Testar `parseUserAttributeValue` com entradas variadas: ` @123`, `id:123`, `Marca=Samsung`, `COR: Azul`.
2.  **Unit√°rio (Pricing):** Testar `analyzePrices` com arrays contendo outliers extremos para garantir que a mediana e os desvios (IQR) est√£o corretos.
3.  **Integra√ß√£o (Mock ML API):** Simular um erro 403 `PolicyAgent` e verificar se o cliente tenta o retry com `auth: true`.
4.  **Integra√ß√£o (Session Lifecycle):** Simular o fluxo `collecting -> analyzing -> awaiting_info` garantindo que o timer de coleta √© resetado corretamente a cada nova foto.

---

## Observa√ß√µes Espec√≠ficas

*   **Baileys:** O uso de `sendQueue` e `humanDelay` √© excelente para mitigar o risco de banimento por comportamento rob√≥tico.
*   **OpenAI Vision:** O uso de `gpt-4o-mini` √© uma escolha custo-benef√≠cio inteligente. Certifique-se de que o `WA_MAX_IMAGE_BYTES` n√£o exceda o limite de upload da OpenAI (geralmente 20MB por imagem).
*   **Mercado Livre:** A estrat√©gia de publicar como **PAUSADO** √© a melhor pr√°tica para evitar infra√ß√µes de pol√≠tica por an√∫ncios incompletos gerados por IA.
