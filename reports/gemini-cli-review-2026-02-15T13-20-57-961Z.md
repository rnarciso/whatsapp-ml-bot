# Gemini CLI Code Review

- model: gemini-2.5-flash-lite
- generated_at: 2026-02-15T13:20:57.962Z
- files_sent: 26
- total_bytes_sent: 194770

Este é um code review do projeto **whatsapp-ml-bot**. O projeto apresenta uma arquitetura sólida, com separação clara de responsabilidades entre serviços de IA, integração de API e lógica do bot.

### Resumo do Review
*   **Arquitetura:** Muito boa separação de camadas (`services`, `bot`, `storage`, `utils`).
*   **Robustez:** Uso de `p-queue` para concorrência e escrita atômica no JSON são pontos positivos.
*   **IA:** Implementação moderna usando *Structured Outputs* da OpenAI.
*   **Mercado Livre:** Tratamento inteligente de erros 403 (PolicyAgent) e fluxo de OAuth completo.
*   **UX:** Fluxo de "Preview" e extração reativa de atributos obrigatórios são excelentes para o usuário final.
*   **Riscos:** Privacidade de mídias locais e potencial loop de reconexão no WhatsApp.

---

### Problemas e Riscos

#### 1. CRÍTICO: Privacidade e Acúmulo de Mídias
*   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (método `handleImage`) e `src/services/cleanup.ts`.
*   **Descrição:** O bot baixa automaticamente todas as imagens enviadas no grupo para o diretório `data/media` antes de validar se são produtos. Se o bot estiver em um grupo movimentado, ele coletará fotos pessoais dos membros.
*   **Risco:** Vazamento de privacidade e consumo excessivo de disco.
*   **Melhoria:** Implementar uma lógica de "ativação". O bot só deve baixar a foto se o usuário enviar um comando prévio ou se o bot identificar (via metadados ou visão rápida de baixo custo) que a imagem tem potencial de ser um produto. Reduzir o `MEDIA_RETENTION_HOURS` para 1 ou 2 horas.

#### 2. ALTO: Loop de Reconexão do Baileys
*   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (método `start`).
*   **Descrição:** No evento `connection.update`, ao detectar `connection === 'close'`, o código chama `void this.start()` imediatamente, a menos que seja um logout deliberado.
*   **Risco:** Se houver um problema persistente (falta de internet, banimento ou erro de credenciais), o bot entrará em um loop infinito de tentativas de reconexão, consumindo CPU e podendo causar banimento por comportamento agressivo.
*   **Melhoria:** Implementar um **Exponential Backoff** para as tentativas de reconexão (ex: esperar 5s, 10s, 20s... até um teto).

#### 3. MÉDIO: Colisão de Sessão por Usuário
*   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (método `findActiveSession`).
*   **Descrição:** A sessão é identificada por `groupId` + `userId`. Se um usuário enviar fotos de dois produtos diferentes em sequência rápida, o bot agrupará tudo no mesmo anúncio.
*   **Risco:** Confusão na geração do anúncio e péssima UX se o usuário estiver tentando processar itens em lote.
*   **Melhoria:** Adicionar um comando `!novo` para resetar a sessão atual ou reduzir a janela `PHOTO_COLLECT_WINDOW_SEC` se uma análise já tiver sido concluída para aquele usuário.

#### 4. MÉDIO: Falta de Retry com Jitter para APIs Externas
*   **Arquivo:** `src/services/mercadoLivre.ts` e `src/services/openaiVision.ts`.
*   **Descrição:** As chamadas para OpenAI e Mercado Livre podem falhar por timeout ou rate limit (429). O código atual lança o erro diretamente para a sessão.
*   **Risco:** Interrupção de fluxos por instabilidades momentâneas de rede.
*   **Melhoria:** Utilizar uma biblioteca como `async-retry` ou implementar um wrapper simples com jitter nas chamadas de rede críticas.

#### 5. BAIXO: Tipagem "any" em Mensagens do WhatsApp
*   **Arquivo:** `src/bot/WhatsAppMlBot.ts` (tipo `WAMessage = any`).
*   **Descrição:** O uso de `any` remove a segurança do compilador em uma das partes mais sensíveis do sistema.
*   **Risco:** Erros de runtime (`undefined is not a function`) ao acessar propriedades de mensagens complexas do WhatsApp.
*   **Melhoria:** Importar e utilizar os tipos oficiais do Baileys (ex: `proto.IWebMessageInfo`).

---

### Observações Específicas

*   **WhatsApp via Baileys:** O uso de `fetchLatestBaileysVersion` é uma ótima prática para evitar dessincronização com o protocolo Web. O bot deveria ignorar explicitamente `protocolMessage` (mensagens deletadas) para não tentar processar imagens removidas.
*   **OpenAI Vision:** O uso de `strict: true` no `json_schema` é excelente. O fallback para `json_object` é prudente, mas em caso de falha de validação Zod no fallback, o bot deveria pedir para o usuário reenviar a foto de um ângulo melhor.
*   **Mercado Livre API:** A lógica de pausar o item após a criação (`pauseItem`) e a descrição separada (`setDescription`) é obrigatória para o fluxo "rascunho", e foi bem implementada. O extrator de `attribute_id` das mensagens de erro do ML (`extractAttributeIdsFromMlError`) é um diferencial técnico de alto nível.

---

### Testes Automatizados Essenciais

1.  **Unitário (Logic):** Testar o `buildListingDraft` com inputs de usuário "sujos" (ex: `preco=R$ 1.200,00`, `condicao=nova`) para garantir que a normalização em `src/services/listingDraft.ts` é resiliente.
2.  **Mock (API):** Simular um erro de expiração de Token do Mercado Livre e validar se o `getAccessToken` realiza o refresh e salva no `store` corretamente sem perder a requisição original.
3.  **Integração (Storage):** Testar a concorrência da `JsonDbStore` garantindo que dois updates simultâneos não causem perda de dados (o uso de `p-queue` com `concurrency: 1` já resolve isso, mas um teste garante a não-regressão).

### Proposta de Melhoria de Impacto
Adicionar uma validação de **"Atributos Obrigatórios"** preventiva. Ao receber a categoria do ML, o bot já poderia buscar os atributos obrigatórios e, se a IA não os detectou nas fotos, já incluir as perguntas específicas no primeiro retorno ao usuário, evitando o erro de publicação lá no final do fluxo.
