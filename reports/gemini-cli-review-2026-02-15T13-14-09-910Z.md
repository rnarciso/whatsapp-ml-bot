# Gemini CLI Code Review

- model: gemini-2.5-flash-lite
- generated_at: 2026-02-15T13:14:09.910Z
- files_sent: 26
- total_bytes_sent: 193847

Este code review foi realizado com foco em robustez, segurança e manutenibilidade do bot de integração WhatsApp/Mercado Livre.

### Resumo do Review

- **Arquitetura Sólida de Sessão**: O sistema de agrupamento de fotos com janela de tempo (`PHOTO_COLLECT_WINDOW_SEC`) é bem implementado.
- **Integração ML madura**: Tratamento de OAuth com refresh token automático e suporte a atributos obrigatórios via `PolicyAgent` 403.
- **Uso Eficiente de IA**: Implementação de *Structured Outputs* da OpenAI garante respostas JSON confiáveis.
- **Risco de Concorrência**: O armazenamento em arquivo JSON (`db.json`) possui uma fila para escritas, mas leituras externas podem obter dados obsoletos.
- **Exposição de Segredos**: Tokens de acesso e refresh do Mercado Livre são persistidos em texto claro no `db.json`.
- **Risco de Plataforma**: O uso de Baileys (não-oficial) exige estratégias defensivas contra banimentos (já possui alguns *delays* humanos).

---

### Detalhamento por Severidade

#### 1. CRÍTICO: Condição de Corrida no Estado da Sessão
**Arquivo:** `src/bot/WhatsAppMlBot.ts` (Métodos `handleText`, `analyzeSession`)
**Problema:** O bot realiza `this.store.read()` para tomar decisões de fluxo fora da fila de mutação do `JsonDbStore`. Se uma mutação estiver pendente na fila, o `read()` retornará o estado antigo do disco. Além disso, operações assíncronas longas (como OpenAI Vision) ocorrem entre a leitura e a escrita do estado.
**Risco:** O usuário pode enviar "cancelar" enquanto a IA está processando, e o bot pode "reviver" a sessão ou processar comandos conflitantes.
**Melhoria:** Implementar um mecanismo de *lock* por `sessionId` ou garantir que todas as verificações de status críticas ocorram dentro do callback de `store.update`.

#### 2. ALTO: Persistência de Tokens em Texto Claro
**Arquivo:** `src/storage/store.ts` e `src/types.ts` (Interface `Db`)
**Problema:** O `access_token` e o `refresh_token` do Mercado Livre são salvos diretamente no `db.json`.
**Risco:** Se o ambiente for comprometido ou se o arquivo `db.json` for exposto acidentalmente, o atacante terá controle total sobre a conta do Mercado Livre do usuário.
**Melhoria:** Criptografar o campo `mlTokens` no disco usando uma chave derivada de uma variável de ambiente (`STORAGE_ENCRYPTION_KEY`).

#### 3. ALTO: Falha Parcial na Publicação ML
**Arquivo:** `src/bot/WhatsAppMlBot.ts` (Método `publishSession`)
**Problema:** O fluxo de publicação segue a ordem: `uploadPicture` -> `createItem` -> `setDescription` -> `pauseItem`. Se `createItem` for bem-sucedido mas `setDescription` falhar, o anúncio existirá no ML sem descrição e possivelmente ativo (se o `pauseItem` também não rodar).
**Risco:** Anúncios incompletos ou incorretos publicados na conta do usuário.
**Melhoria:** Envolver as chamadas pós-criação em um bloco `try/catch` de alta resiliência com retentativas (retry) ou garantir que a criação ocorra já com o status `paused` (o que já é tentado no payload, mas o fluxo de descrição é uma chamada separada na API do ML).

#### 4. MÉDIO: Gestão de Mídia e PII (Privacidade)
**Arquivo:** `src/services/cleanup.ts`
**Problema:** Fotos de produtos (que podem conter rostos, endereços ou dados sensíveis) são armazenadas em `data/media`. O cleanup é baseado em tempo, mas não há hash de limpeza imediata após `done` ou `cancelled`.
**Risco:** Acúmulo desnecessário de dados privados.
**Melhoria:** Disparar a exclusão das fotos da sessão imediatamente após o status mudar para `done` ou `cancelled`, em vez de esperar o loop de cleanup de 24h.

#### 5. MÉDIO: Validação de Atributos do Mercado Livre
**Arquivo:** `src/services/listingDraft.ts` e `src/utils/mlAttributes.ts`
**Problema:** A lógica de mapeamento de atributos (`BRAND`, `MODEL`, etc) é manual e propensa a erros de tipagem da API.
**Melhoria:** Utilizar o endpoint `/categories/{id}/attributes` para validar se o `value_name` fornecido pelo usuário é aceitável ou se exige um `value_id` específico antes de tentar o `createItem`.

---

### Observações Específicas

- **WhatsApp (Baileys):** O bot utiliza `humanDelay` e `sendQueue` (concorrência 1), o que é excelente para mitigar detecção de bot. Recomenda-se adicionar um jitter aleatório maior entre mensagens de análise.
- **OpenAI Vision:** O uso de `gpt-4o-mini` é uma escolha custo-benefício inteligente. O prompt está bem estruturado, mas falta um tratamento para quando a imagem é borrada ou irreconhecível (retornar `confidence` baixo e pedir nova foto).
- **Mercado Livre API:** O tratamento do erro `PolicyAgent` (403) em `src/services/mercadoLivre.ts` é um ponto alto do projeto, demonstrando conhecimento das particularidades da API.

### Sugestões de Testes Essenciais

1. **Teste de Integração de Fluxo de Erro**: Simular falha no `uploadPicture` para garantir que a sessão não fique travada em `publishing`.
2. **Teste de Concorrência**: Simular o envio de 5 fotos simultâneas de usuários diferentes para validar a integridade do `db.json`.
3. **Unitário de Parser BRL**: Testar `parseNumberLoose` com variações como "R$ 1.200,00", "1200", "1.200" para evitar erros de preço.
4. **Mock de OAuth**: Testar o cenário onde o `refresh_token` expira para validar se o bot notifica o grupo corretamente pedindo nova autorização.

### Proposta de Melhoria de Código

No arquivo `src/storage/store.ts`, adicione um cache em memória para leituras:

```typescript
// No JsonDbStore
private cache: Db | null = null;

async read(): Promise<Db> {
  if (this.cache) return this.cache;
  // ... leitura do arquivo ...
  this.cache = parsed;
  return parsed;
}

// No update, atualizar o cache após a mutação
```
Isso garante que chamadas subsequentes de `read()` vejam o que está prestes a ser escrito pela fila, mitigando condições de corrida de leitura.
